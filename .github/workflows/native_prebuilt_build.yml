name: Native Prebuilt Build

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'packages/opentui_native/**'
      - 'ref/opentui/packages/core/src/zig/**'
      - '.github/workflows/native_prebuilt_build.yml'

jobs:
  native-prebuilt:
    strategy:
      fail-fast: false
      matrix:
        runner:
          - ubuntu-latest
          - macos-latest
    runs-on: ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap
        run: melos bootstrap

      - name: Validate symbol parity
        working-directory: packages/opentui_native
        run: dart run tool/verify_symbols.dart

      - name: Validate checksum manifest
        working-directory: packages/opentui_native
        run: dart run tool/verify_checksums.dart

      - name: Build prebuilt script smoke
        working-directory: packages/opentui_native
        run: ./tool/build_prebuilt.sh --force

      - name: Validate platform coverage
        working-directory: packages/opentui_native
        run: dart run tool/verify_platform_coverage.dart

      - name: Validate checksum manifest after build
        working-directory: packages/opentui_native
        run: dart run tool/verify_checksums.dart
